BIN_DIR := ./bin
BIN_CALENDAR      := $(BIN_DIR)/calendar
BIN_SCHEDULER     := $(BIN_DIR)/calendar_scheduler
BIN_SENDER        := $(BIN_DIR)/calendar_sender
CALENDAR_CONFIG := "./configs/calendar.yaml"
SCHEDULER_CONFIG := "./configs/scheduler.yaml"
SENDER_CONFIG := "./configs/sender.yaml"
IMG_CALENDAR      := calendar:latest
IMG_SCHEDULER     := calendar-scheduler:latest
IMG_SENDER        := calendar-sender:latest
.DEFAULT_GOAL := help

GIT_HASH := $(shell git log --format="%h" -n 1)
LDFLAGS := -X main.release="develop" -X main.buildDate=$(shell date -u +%Y-%m-%dT%H:%M:%S) -X main.gitHash=$(GIT_HASH)

# –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ docker-compose vs docker compose
DOCKER_COMPOSE := $(shell command -v docker-compose 2> /dev/null)
ifeq ($(DOCKER_COMPOSE),)
	DOCKER_COMPOSE := LDFLAGS='$(LDFLAGS)' docker compose
else
	DOCKER_COMPOSE := LDFLAGS='$(LDFLAGS)' docker-compose
endif
COMPOSE_FILE := ./deployments/docker-compose.yaml

# PostgreSQL
POSTGRES_USER ?= postgres
POSTGRES_PASSWORD ?= password
POSTGRES_DB ?= backend
POSTGRES_PORT ?= 5432
POSTGRES_CONTAINER := postgres-calendar
POSTGRES_APP_DB_NAME ?= calendar
POSTGRES_APP_USER ?= calendar
POSTGRES_APP_PASS ?= calendar
POSTGRES_MIGRATIONS_DIR ?= ./internal/migration

# RabbitMQ
RABBIT_USER ?= calendar
RABBIT_PASSWORD ?= calendar
RABBIT_PORT ?= 5672
RABBIT_PORT_UI ?= 15672
RABBIT_CONTAINER := rabbitmq

## –ó–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL –≤ Docker
run-postgres:
	docker run -d --name $(POSTGRES_CONTAINER) \
	-e POSTGRES_USER=$(POSTGRES_USER) \
	-e POSTGRES_PASSWORD=$(POSTGRES_PASSWORD) \
	-e POSTGRES_DB=$(POSTGRES_DB) \
	-p $(POSTGRES_PORT):5432 \
	-v postgres-data:/var/lib/postgresql \
	postgres:18

## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä PostgreSQL
stop-postgres:
	docker rm -f $(POSTGRES_CONTAINER)

## –ó–∞–ø—É—Å—Ç–∏—Ç—å RabbitMQ –≤ Docker
run-rabbit:
	docker run -d --name $(RABBIT_CONTAINER) \
	-p $(RABBIT_PORT):5672 \
	-p $(RABBIT_PORT_UI):15672 \
	-e RABBITMQ_DEFAULT_USER=$(RABBIT_USER) \
	-e RABBITMQ_DEFAULT_PASS=$(RABBIT_PASSWORD) \
	-e RABBITMQ_DEFAULT_VHOST="/" \
	rabbitmq:3-management

## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä RabbitMQ
stop-rabbit:
	docker rm -f $(RABBIT_CONTAINER)

## –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
initdb:
	@echo "üîç Checking if user $(POSTGRES_APP_USER) exists..."
	@docker exec -i $(POSTGRES_CONTAINER) psql -U $(POSTGRES_USER) -tAc "SELECT 1 FROM pg_roles WHERE rolname='$(POSTGRES_APP_USER)';" | grep -q 1 || \
		(docker exec -i $(POSTGRES_CONTAINER) psql -U $(POSTGRES_USER) -c "CREATE USER $(POSTGRES_APP_USER) WITH PASSWORD '$(POSTGRES_APP_PASS)';" && echo "‚úÖ User created.") || \
		(echo "‚ùå Failed to create user $(POSTGRES_APP_USER)" && exit 1)

	@echo "üîç Checking if database $(POSTGRES_APP_DB_NAME) exists..."
	@docker exec -i $(POSTGRES_CONTAINER) psql -U $(POSTGRES_USER) -tAc "SELECT 1 FROM pg_database WHERE datname='$(POSTGRES_APP_DB_NAME)';" | grep -q 1 || \
		(docker exec -i $(POSTGRES_CONTAINER) psql -U $(POSTGRES_USER) -c "CREATE DATABASE $(POSTGRES_APP_DB_NAME) OWNER $(POSTGRES_APP_USER);" && echo "‚úÖ Database created.") || \
		(echo "‚ùå Failed to create database $(POSTGRES_APP_DB_NAME)" && exit 1)

	@echo "‚úÖ Database and user ready."

## –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL-–º–∏–≥—Ä–∞—Ü–∏–∏ –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
migrate:
	@echo "Applying migrations from $(POSTGRES_MIGRATIONS_DIR)..."
	@if [ ! -d "$(POSTGRES_MIGRATIONS_DIR)" ]; then \
		echo "‚ùå Migrations directory not found: $(POSTGRES_MIGRATIONS_DIR)"; \
		exit 1; \
	fi
	@set -o pipefail; \
	for f in $$(ls -1v $(POSTGRES_MIGRATIONS_DIR)/*.up.sql 2>/dev/null || true); do \
		if [ -n "$$f" ]; then \
			echo "‚Üí Applying $$f"; \
			cat "$$f" | docker exec -i $(POSTGRES_CONTAINER) psql -v ON_ERROR_STOP=1 -U $(POSTGRES_APP_USER) -d $(POSTGRES_APP_DB_NAME); \
		fi; \
	done
	@echo "‚úÖ All migrations applied."

## –°–æ–±—Ä–∞—Ç—å –±–∏–Ω–∞—Ä–Ω–∏–∫–∏: calendar, scheduler, sender
build: $(BIN_CALENDAR) $(BIN_SCHEDULER) $(BIN_SENDER)

## –°–±–æ—Ä–∫–∞ calendar
$(BIN_CALENDAR):
	@mkdir -p $(BIN_DIR)
	go build -v -o $@ -ldflags "$(LDFLAGS)" ./cmd/calendar

## –°–±–æ—Ä–∫–∞ calendar_scheduler
$(BIN_SCHEDULER):
	@mkdir -p $(BIN_DIR)
	go build -v -o $@ -ldflags "$(LDFLAGS)" ./cmd/calendar_scheduler

## –°–±–æ—Ä–∫–∞ calendar_sender
$(BIN_SENDER):
	@mkdir -p $(BIN_DIR)
	go build -v -o $@ -ldflags "$(LDFLAGS)" ./cmd/calendar_sender

## –ó–∞–ø—É—Å—Ç–∏—Ç—å calendar –ª–æ–∫–∞–ª—å–Ω–æ
run-calendar:
	$(BIN_CALENDAR) --config $(CALENDAR_CONFIG)

## –ó–∞–ø—É—Å—Ç–∏—Ç—å scheduler –ª–æ–∫–∞–ª—å–Ω–æ
run-scheduler:
	$(BIN_SCHEDULER) --config $(SCHEDULER_CONFIG)

## –ó–∞–ø—É—Å—Ç–∏—Ç—å sender –ª–æ–∫–∞–ª—å–Ω–æ
run-sender:
	$(BIN_SENDER) --config $(SENDER_CONFIG)

## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ª–æ–∫–∞–ª—å–Ω–æ (–≤ —Ñ–æ–Ω–µ)
run-all: build
	@echo "Starting all services..."
	$(BIN_CALENDAR) --config $(CALENDAR_CONFIG) &
	$(BIN_SCHEDULER) --config $(SCHEDULER_CONFIG) &
	$(BIN_SENDER) --config $(SENDER_CONFIG) &
	@echo "All services started in background. PID: $$!"

## –£–±–∏—Ç—å –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (calendar, scheduler, sender)
kill-all:
	-killall calendar calendar_scheduler calendar_sender 2>/dev/null || true

## –°–æ–±—Ä–∞—Ç—å Docker-–æ–±—Ä–∞–∑—ã –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
build-img:
	docker build \
		--build-arg LDFLAGS="$(LDFLAGS)" \
		-t $(IMG_CALENDAR) \
		-f build/Dockerfile.calendar .

	docker build \
		--build-arg LDFLAGS="$(LDFLAGS)" \
		-t $(IMG_SCHEDULER) \
		-f build/Dockerfile.scheduler .

	docker build \
		--build-arg LDFLAGS="$(LDFLAGS)" \
		-t $(IMG_SENDER) \
		-f build/Dockerfile.sender .

## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë —á–µ—Ä–µ–∑ docker-compose (production-like)
up:
	$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) up -d --build

## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏–∑ docker-compose
down:
	$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) down

## –£–¥–∞–ª–∏—Ç—å Docker volumes (–¥–ª—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏)
vrm:
	docker volume rm calendar_postgres_data calendar_rabbitmq_data

## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
logs:
	$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) logs -f calendar calendar-scheduler calendar-sender

## –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
ps:
	$(DOCKER_COMPOSE) -f $(COMPOSE_FILE) ps -a

## –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏
integration-tests:
	@set -e; \
	EXIT_CODE=0; \
	$(DOCKER_COMPOSE) -f tests/integration/docker-compose.test.yaml \
		up --build \
		--abort-on-container-exit \
		--exit-code-from integration-test \
		--attach integration-test \
	|| EXIT_CODE=$$?; \
	$(DOCKER_COMPOSE) -f tests/integration/docker-compose.test.yaml down -v --remove-orphans; \
	if [ $$EXIT_CODE -eq 0 ]; then \
	    echo "Integration tests passed"; \
	    exit 0; \
	else \
		echo "Integration tests failed"; \
		exit 1; \
	fi

## –ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ä—Å–∏—é calendar (—Ç—Ä–µ–±—É–µ—Ç —Å–±–æ—Ä–∫–∏)
version: build
	$(BIN_CALENDAR) version

## –ó–∞–ø—É—Å—Ç–∏—Ç—å unit-—Ç–µ—Å—Ç—ã
test:
	go test -race ./internal/...

## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å golangci-lint (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
install-lint-deps:
	(which golangci-lint > /dev/null) || curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh   | sh -s -- -b $(shell go env GOPATH)/bin v1.62.2

## –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä
lint: install-lint-deps
	golangci-lint run ./...

## –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å gRPC –∫–æ–¥ –∏–∑ .proto
generate:
	protoc --go_out=. --go-grpc_out=. api/EventService.proto

## –£–¥–∞–ª–∏—Ç—å —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–∏
clean:
	rm -f $(BIN_CALENDAR) $(BIN_SCHEDULER) $(BIN_SENDER)

## –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
help:
	@echo "Usage: make [target]"
	@echo ""
	@echo "Targets:"
	@awk '/^[a-zA-Z0-9_-]+:/ { \
		help_line = match(prev, /^## (.*)/); \
		if (help_line) { \
			printf "  %-25s %s\n", $$1, substr(prev, RSTART + 3, RLENGTH - 3) \
		} else { \
			printf "  %-25s %s\n", $$1, "[no description]" \
		} \
	} \
	{ prev = $$0 }' $(MAKEFILE_LIST)

.PHONY: \
	help build run-calendar run-scheduler run-sender run-all kill-all \
	build-img up down vrm logs ps integration-tests version test \
	lint install-lint-deps generate clean \
	run-postgres stop-postgres run-rabbit stop-rabbit initdb migrate
